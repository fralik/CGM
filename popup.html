<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>CGM</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <script src="common.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="includes/demos.css" />
    <!--<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" />-->
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/redmond/jquery-ui.css" type="text/css" />
    
    <style type="text/css">
    .ui-widget-content {
        width: 150px; 
        float: left; 
        margin: 5px; 
        padding: 5px; 
        border: none;
    }
    #informer {
        width: 450px;
        margin: 7px;
        padding: 3px;
        border: none;
    }
    #popup_usage_description, #donation_text {
        width: 460px;
    }
    #visible, #hidden { 
        list-style-type: none; 
        margin: 10px; 
        padding: 0; 
        margin-right: 10px; 
    }
    #visible li, #hidden li { 
        margin: 0 5px 5px 5px; 
        padding: 5px; 
        font-size: 1.2em; 
        width: 120px; 
    }
    .action { 
        color: #333333; 
        text-decoration: none; 
        border-bottom:1px dashed;
    }
    body {
        min-width: 510px;
        overflow-x:hidden;
    }
    #paypal {
        float: left;
    }
    #yandex {
        float: center;
    }

    </style>
    <script type="text/javascript">
    var toDo = Array();
    // points to the communication port
    var popupPort = null;

    function createLinks(layout)
    {
        if (layout == undefined || !(layout.hasOwnProperty('visible')) || !(layout.hasOwnProperty('hidden')) )
            return ;

        //console.log('CGM, popup, createLinks');
        parseLinksAndAdd(layout.visible, "visible");
        parseLinksAndAdd(layout.hidden, "hidden");
    }

    function parseLinksAndAdd(links, containerId)
    {
        var className;

        if (containerId.indexOf("visible") > -1)
            className = "ui-state-default";
        else
            className = "ui-state-highlight";

        var selector = "#" + containerId;
        for (var i=0; i < links.length; i++) {
            $(selector).append('<li class="' + className + '" id="' + links[i].id + '">' + links[i].text + '</li>');
        }
    }

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26179092-1']);
    _gaq.push(['_trackPageview']);

    $(document).ready(function() {

        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    
        $( "#visible, #hidden" ).sortable({
            connectWith: ".connectedSortable",
            cursor: "move",
        }).disableSelection();

        $("ul, li").disableSelection();

        //console.log('toDo length: ' + toDo.length);
        for (var i=0; i < toDo.length; i++) {
            if (toDo[i] == cgmMessages.WRONG_URL_MSG) {
                //console.log('Got Wrong_url in toDO');
                $("#informer").html(i18n.get("informer_wrong_url"));
                $("#informer").css('font-size','16px');
                $(".demo").css('visibility', 'hidden');
            }
        }

        $('#popup_usage_description').html(i18n.get('popup_usage_description'));
        $('.save').html(i18n.get('save_text'));
        $('#visible_list_text').html(i18n.get('visible_list_text'));
        $('#hidden_list_text').html(i18n.get('hidden_list_text'));
        $('#donation_text').html(i18n.get('donation_text'));

        $(".save").click(function() {
            if ($('#visible li').length < 4) {
                $('#informer').text(i18n.get('error_few_visible'));
                $("#informer").css('color','red');
                return ;
            }
            if ($('#hidden li').length < 6) {
                $('#informer').text(i18n.get('error_few_hidden'));
                $("#informer").css('color','red');
                return ;
            }

            $('#informer').css('visibility', 'hidden');
            //var visibleAndHidden = "visible;";
            var visibleItems = [];
            var hiddenItems = [];
            $("#visible li").each(function() {
                //visibleAndHidden += $(this).attr('id') + ',' + $(this).text() + ';';
                visibleItems.push({id: $(this).attr('id'), text: $(this).text()});
            });
            //visibleAndHidden += '##hidden;';
            $("#hidden li").each(function() {
                //visibleAndHidden += $(this).attr('id') + ',' + $(this).text() + ';';
                hiddenItems.push({id: $(this).attr('id'), text: $(this).text()});
            });

            sendMessage({action: "layout", visible: visibleItems, hidden: hiddenItems});

            cgm.common.saveLayout({action: "layout", visible: visibleItems, hidden: hiddenItems});

            window.close();
        });

        $('.reset').click(function() {
            cgm.common.resetLayout();
            sendMessage({action: cgmMessages.RELOAD});
            window.close();
        });

        if (typeof chrome !== "undefined") {
            chrome.tabs.getSelected(null, function(tab) {
                var port = chrome.tabs.connect(tab.id, {name: cgmMessages.PORT_NAME});
                savePort(port);
                port.onMessage.addListener(injectListener);
                port.postMessage({action: cgmMessages.SEND_LINKS});
            });
        }
    });

    // Chrome and Opera differ in msg format for listener. Opera
    // sets actual data in .data property.
    function injectListener(msg) {
        //console.error('in popup listener:' + msg.data);
        var actualMsg = msg;
        if (typeof opera !== "undefined") {
            actualMsg = msg.data;
        }
        if (actualMsg.action == cgmMessages.LAYOUT) {
            createLinks(actualMsg);
        }
    }

    if (typeof opera !== "undefined") {
        opera.extension.onmessage = function(event) {
            //console.log('Popup got message: ' + event.data.action);

            //alert(event.data.action == cgmMessages.PORT_TO_POPUP);

            if (event.data.action == cgmMessages.PORT_TO_POPUP) {
                console.log('We are in popup: ' + event.source);
                if(event.ports.length > 0 ) {
                    popupPort = event.ports[0];
                    popupPort.onmessage = injectListener;
                }

                // always get links from the injected. This is done in case user switched the language elsewhere.
                // Then we'll get proper text from injected.
                sendMessage({action: cgmMessages.SEND_LINKS});
            } else if (event.data.action == cgmMessages.WRONG_URL_MSG) {
                toDo.push(cgmMessages.WRONG_URL_MSG);
                //console.log('CGM, popup, Opera onmessage: received wrong_url, put it into toDo');
            }
        }
    }

    // Saves communication port for further use. This function is used
    // to save the port in Chrome from a nested function.
    function savePort(port) {
        popupPort = port;
    }

    function sendMessage(message) {
        if (popupPort) {
            popupPort.postMessage(message);
            return true;
        }
        return false;
    }
    
    function trackButton(button_id) {
        _gaq.push(['_trackEvent', 'button' + button_id, 'clicked']);
    }
    </script>
  </head>
  <body>
    <div class="demo">
        <p id="donation_text">If you like this extension, please, consider a donation. It will encourage me for further development.
            <div id="paypal">
                <form action="https://www.paypal.com/cgi-bin/webscr" method="post" name="paypal" target="_blank">
                    <input type="hidden" name="cmd" value="_s-xclick" />
                    <input type="hidden" name="hosted_button_id" value="4EVHZDWEYQZLN" />
                    <input type="image" src="https://www.paypalobjects.com/en_GB/i/btn/btn_donate_SM.gif" border="0" name="submit" alt="PayPal â€” The safer, easier way to pay online." onclick="trackButton('paypal'); return true;"/>
                    <img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1" />
                </form>
            </div>
            <div id="yandex">
                <form name="yand" style="margin: 0; padding: 0 0 2px;" action="https://money.yandex.ru/donate.xml" method="post" target="_blank">
                    <input type="hidden" name="to" value="410011106982479" />
                    <input type="hidden" name="s5" value="1rub" />
                    <input type="submit" value="Yandex.Money" onclick="trackButton('yandex'); return true;"/>
                </form>
            </div>
        </p>
    </div>
    <p id="informer"></p>
    <div class="demo">
        <p id="popup_usage_description">Drag items from one list to another. Press <a class="action save" href="#">Save</a> when you are done. Press <a href="#" class="action reset">Reset</a> to restore original Google&#0153; menu.</p>
    <div class="ui-widget-content"><p id="visible_list_text">Visible list:</p>
        <ul id="visible" class="connectedSortable"></ul>
    </div>

    <div class="ui-widget-content"><p id="hidden_list_text">Hidden list:</p>
        <ul id="hidden" class="connectedSortable"></ul>
    </div>

    <div class="ui-widget-content"><a href="#" class="action save">Save</a></div>
    </div>
  </body>
</html>